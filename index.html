<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Yusuf Runner</title>
  <style>
    :root { color-scheme: dark; }
    html, body { margin:0; height:100%; background:#0b0f14; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #wrap { height:100%; display:flex; align-items:center; justify-content:center; padding:12px; }
    canvas{
      width:min(92vw, 420px);
      height:calc(min(92vw, 420px) * 1.78);
      background:#000;
      border:2px solid rgba(255,255,255,.12);
      border-radius:14px;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      touch-action: manipulation;
    }

    #overlay{
      position:fixed; inset:0; display:none;
      background:rgba(0,0,0,.60);
      align-items:center; justify-content:center;
      padding:18px;
    }
    #card{
      width:min(520px, 92vw);
      background:#111826;
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:16px;
      box-shadow:0 16px 50px rgba(0,0,0,.5);
    }
    #qtitle{ margin:0 0 8px; font-size:16px; opacity:.9; }
    #qtext{ margin:0 0 12px; font-size:18px; line-height:1.25; }
    .opt{
      width:100%;
      text-align:left;
      padding:12px;
      margin:8px 0;
      background:#0e1522;
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      color:#eaf1ff;
      font-size:16px;
    }
    #hint{ margin:10px 2px 0; font-size:13px; opacity:.75; }

    #toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px; padding:10px 14px;
      background:rgba(17,24,38,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px; display:none;
      font-size:14px;
      max-width:92vw;
      text-align:center;
    }

    /* âœ… KAPANIÅ NOTU (ASLA KAPANMAZ) */
    #endOverlay{
      position:fixed; inset:0; display:none;
      background:rgba(0,0,0,.78);
      align-items:center; justify-content:center;
      padding:18px;
      z-index:9999;
    }
    #endCard{
      width:min(560px, 92vw);
      background:#111826;
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      padding:18px;
      box-shadow:0 18px 60px rgba(0,0,0,.6);
      text-align:center;
    }
    #endTop{ font-size:13px; opacity:.8; margin-bottom:6px; color:#eaf1ff; }
    #endTitle{ font-size:20px; line-height:1.2; margin-bottom:10px; color:#eaf1ff; }
    #endText{ font-size:15px; line-height:1.35; opacity:.92; color:#eaf1ff; white-space:pre-line; }
  </style>
</head>
<body>
<div id="wrap">
  <canvas id="c" width="240" height="426"></canvas>
</div>

<div id="overlay">
  <div id="card">
    <p id="qtitle">Quiz</p>
    <p id="qtext">Soru</p>
    <button class="opt" data-i="0"></button>
    <button class="opt" data-i="1"></button>
    <button class="opt" data-i="2"></button>
    <button class="opt" data-i="3"></button>
    <p id="hint">3 soru var. Bitince final ekranÄ±na geÃ§eceksin.</p>
  </div>
</div>

<div id="toast"></div>

<!-- âœ… KAPANIÅ NOTU OVERLAY -->
<div id="endOverlay">
  <div id="endCard">
    <div id="endTop">Yusuf Runner</div>
    <div id="endTitle">Ä°yi ki doÄŸdun! ğŸ‚</div>
    <div id="endText">DoÄŸum gÃ¼nÃ¼n iÃ§in ne yapabilirim diye dÃ¼ÅŸÃ¼ndÃ¼m, hem anÄ±larÄ±mÄ± sana yansÄ±tmak hem de teÅŸekkÃ¼r etmek iÃ§in site yaptÄ±m,yordu.... Son yÄ±llarda en sevdiÄŸim kiÅŸilerden belki de en sevdiÄŸim oldun. Her ne kadar ben senin iÃ§in pek anlamlÄ± olmasam da, bana abilik, arkadaÅŸlÄ±k, patronluk, hayallerimde sevgililikğŸ˜‰ yaptÄ±n. Seninle arkadaÅŸÄ±n olabilecek bi yaÅŸta vs olmayÄ± istedim. Seni Ã§ok darladÄ±m, sohbet, ilgi, Ã§Ä±ktÄ± Ã§ok ÅŸey istedim. Bunun rahatsÄ±z ettiÄŸinin ve bi yere varmadÄ±ÄŸÄ±nÄ±n farkÄ±ndayÄ±m. Bundan sonra rahatsÄ±z etmeyeceÄŸim. SÃ¶zlerini tutmadÄ±n ama 18 olunca abi dememeye anlaÅŸmÄ±ÅŸtÄ±k. Kendine iyi bak Yusuf.\nHer bÃ¶lÃ¼m ayrÄ± bir anÄ±. ğŸ’š\n -Can Ensar Abi oyundan ayrÄ±ldÄ±...</div>
  </div>
</div>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  ctx.imageSmoothingEnabled = false;

  const overlay = document.getElementById('overlay');
  const qtext = document.getElementById('qtext');
  const optBtns = Array.from(document.querySelectorAll('.opt'));
  const toast = document.getElementById('toast');

  // âœ… KapanÄ±ÅŸ overlay refs
  const endOverlay = document.getElementById('endOverlay');
  const endTitle = document.getElementById('endTitle');
  const endText  = document.getElementById('endText');

  // KapanÄ±ÅŸ metni (istediÄŸin gibi deÄŸiÅŸtir)
  const END_NOTE_TITLE = "Ä°yi ki doÄŸdun Yusuf! ğŸ‚";
  const END_NOTE_TEXT  = "Bu siteyi senin iÃ§in yaptÄ±m.\nHer bÃ¶lÃ¼m ayrÄ± bir anÄ±. ğŸ’š";
  let endLocked = false; // âœ… bir kez aÃ§Ä±lÄ±nca oyun kilit

  const W = canvas.width, H = canvas.height;

  // ---------- Assets (Level 1 + Level 2 + Level 3) ----------
  // Level 1
  const bg1 = new Image();     bg1.src = "assets/bg_loop.png";
  const paper1 = new Image();  paper1.src = "assets/paper.png";
  const book1a = new Image();  book1a.src = "assets/books2.png";
  const book1b = new Image();  book1b.src = "assets/books3.png";

  // Level 2 (assets/level2/*)
  const bg2 = new Image();     bg2.src = "assets/level2/bg_loop.png";
  const bird2 = new Image();   bird2.src = "assets/level2/bird.png";
  const trash2 = new Image();  trash2.src = "assets/level2/trash.png";
  const ball2 = new Image();   ball2.src = "assets/level2/ball.png";

  // Level 3 (assets/level3/*)
  const cone3  = new Image();  cone3.src  = "assets/level3/cone.png";
  const crate3 = new Image();  crate3.src = "assets/level3/crate.png";

  // Shield
  const shieldImg = new Image(); shieldImg.src = "assets/shield.png";

  // âœ… FINAL MP4
  const finalVid = document.createElement("video");
  finalVid.loop = true;
  finalVid.muted = true;
  finalVid.playsInline = true;
  finalVid.preload = "auto";

  function ready(img){ return img && img.complete && img.naturalWidth > 0; }

  // ---------- RUN SPRITE ----------
  const RUN_DIR = "assets/run_frames";
  const RUN_TOTAL = 193;
  const RUN_INTRO_END = 5;
  const RUN_LOOP_START = 6;
  const RUN_FPS = 24;

  const runFrames = new Array(RUN_TOTAL);
  let runLoaded = 0;

  for(let i=0;i<RUN_TOTAL;i++){
    const im = new Image();
    im.src = `${RUN_DIR}/frame_${String(i).padStart(3,'0')}.png`;
    im.onload = ()=> runLoaded++;
    runFrames[i] = im;
  }

  let runFrame = 0;
  let runPhase = "intro";
  let runAcc = 0;

  function resetRunAnim(){
    runFrame = 0;
    runPhase = "intro";
    runAcc = 0;
  }

  function updateRunAnim(dt){
    runAcc += dt;
    const step = 1 / RUN_FPS;
    while(runAcc >= step){
      runAcc -= step;
      runFrame++;
      if(runPhase === "intro"){
        if(runFrame > RUN_INTRO_END){
          runPhase = "run";
          runFrame = RUN_LOOP_START;
        }
      } else {
        if(runFrame >= RUN_TOTAL){
          runFrame = RUN_LOOP_START;
        }
      }
    }
  }

  // âœ… Karakter boyutu
  const SPRITE_TARGET_H = 85;
  const SPRITE_OX = -6;
  const SPRITE_OY = -2;

  // âœ… Yusuf hitbox
  const HB_OX = 10;
  const HB_OY = -2;
  const HB_W  = 18;
  const HB_H  = 36;

  const DEBUG_HITBOX = false;

  // ---------- Game constants ----------
  const GROUND_Y = 382;
  const GRAV = 0.55;
  const JUMP_V = -10.2;

  // ---------- Levels config ----------
  let obstacles = [];

  const levels = {
    1: {
      id: 1,
      name: "BÃ¶lÃ¼m 1 â€” BeÅŸiktaÅŸ",
      bg: bg1,
      finalSrc: "assets/final.mp4",
      hint: "Engeller: KaÄŸÄ±t + Kitap",
      quizzes: [
        { q:"Yusuf bu dÃ¶nem girdiÄŸi 3 sÄ±navdan kaÃ§Ä±nÄ± geÃ§miÅŸtir?", options:["0","1","2","3"], correct:2 },
        { q:"Yusuf'un Can'Ä±n aÄŸzÄ±na verdiÄŸi sÃ¼tlÃ¼ ÅŸey nedir?", options:["SÃ¼tlaÃ§","Kinder SÃ¼t Dilimi","Ã‡ilekli SÃ¼t","AyÄ±p"], correct:1 },
        { q:"Yusuf nerede kumar oynayÄ±p kazanmÄ±ÅŸtÄ±r?", options:["Romanya","KÄ±brÄ±s","Romanya","GÃ¼rcistan"], correct:3 },
      ],
      spawnObstacle(){
        const r = Math.random();
        if(r < 0.45){
          const w = 40, h = 32;
          obstacles.push({
            img: paper1,
            x: W + 20,
            y: (GROUND_Y - 110 - Math.random()*45) | 0,
            w, h,
            colOX: 8, colOY: 6, colW: w - 16, colH: h - 12
          });
        } else {
          const img = Math.random() < 0.5 ? book1a : book1b;
          const w = 44;
          const h = (img === book1a) ? 28 : 40;
          obstacles.push({
            img,
            x: W + 20,
            y: GROUND_Y - h,
            w, h,
            colOX: 7, colOY: 6, colW: w - 14, colH: h - 12
          });
        }
      }
    },

    2: {
      id: 2,
      name: "BÃ¶lÃ¼m 2 â€” Park",
      bg: bg2,
      finalSrc: "assets/level2/final.mp4",
      hint: "Engeller: KuÅŸ + Ã‡Ã¶p + Top",
      quizzes: [
        { q:"Kirpiler ne sever?", options:["Elma","SarÄ±ÅŸÄ±n","Ã‡ay","HaÅŸlanmÄ±ÅŸ yumurta"], correct:3 },
        { q:"Yusuf Can'Ä±n aÄŸzÄ±na ne vermemiÅŸtir?", options:["Pizza","Kebap","Makarna","Bueno"], correct:1 },
        { q:"Yusuf ve Can kaÃ§ gÃ¼n gÃ¶rÃ¼ÅŸmemiÅŸtir?(kÃ¼smek!)", options:["34","56","48","29"], correct:2 },
      ],
      spawnObstacle(){
        const r = Math.random();
        if(r < 0.40){
          const w = 38, h = 28;
          obstacles.push({
            img: bird2,
            x: W + 20,
            y: (GROUND_Y - 115 - Math.random()*55) | 0,
            w, h,
            colOX: 6, colOY: 6, colW: w - 12, colH: h - 12
          });
        } else if(r < 0.75){
          const w = 42, h = 44;
          obstacles.push({
            img: trash2,
            x: W + 20,
            y: GROUND_Y - h,
            w, h,
            colOX: 8, colOY: 8, colW: w - 16, colH: h - 12
          });
        } else {
          const w = 34, h = 34;
          obstacles.push({
            img: ball2,
            x: W + 20,
            y: GROUND_Y - h,
            w, h,
            colOX: 6, colOY: 6, colW: w - 12, colH: h - 12
          });
        }
      }
    },

    3: {
      id: 3,
      name: "BÃ¶lÃ¼m 3 â€” Sokak",
      bg: bg1,
      finalSrc: "assets/level3/final.mp4",
      hint: "Engeller: Koni + Kasa",
      quizzes: [
        { q:"Ã‡amlÄ±ca Market ÅŸube hangi ayda aÃ§Ä±ldÄ±?", options:["Temmuz","Haziran","AÄŸustos","EylÃ¼l"], correct:2 },
        { q:"Kedi Yusuf'a ne dedi?", options:["HoÅŸt!","Sg","PiÅŸt!","Gider misin kardeÅŸim!"], correct:2 },
        { q:"Can bunu yaparken yoruldu mu?", options:["Ã§ok","yok","az","(cevap a)"], correct:0 },
      ],
      spawnObstacle(){
        const r = Math.random();
        if(r < 0.55){
          const w = 36, h = 42;
          obstacles.push({
            img: cone3,
            x: W + 20,
            y: GROUND_Y - h,
            w, h,
            colOX: 8, colOY: 8,
            colW: w - 16, colH: h - 10
          });
        } else {
          const w = 52, h = 40;
          obstacles.push({
            img: crate3,
            x: W + 20,
            y: GROUND_Y - h,
            w, h,
            colOX: 8, colOY: 8,
            colW: w - 16, colH: h - 12
          });
        }
      }
    }
  };

  const MAX_LEVEL = 3;
  let currentLevel = 1;
  let level = levels[currentLevel];

  // ---------- State ----------
  let state = "start"; // start | run | quiz | final | gameover
  let speed = 2.8;
  let bgX = 0;

  const player = {
    x: 44, y: GROUND_Y - 18,
    w: 14, h: 18,
    vy: 0, onGround: true,
    shield: false,
    invul: 0
  };

  let nextSpawn = 40;

  let shieldDrops = [];
  let nextShield = 200;

  let elapsed = 0;
  const LEVEL_SECONDS = 35;

  // Quiz
  let quizzes = levels[1].quizzes;
  let quizIndex = 0;

  function loadLevel(n){
    currentLevel = Math.max(1, Math.min(MAX_LEVEL, n));
    level = levels[currentLevel];

    finalVid.pause();
    finalVid.currentTime = 0;
    finalVid.src = level.finalSrc;
    finalVid.load();

    quizzes = level.quizzes;
    quizIndex = 0;

    document.title = `Yusuf Runner - ${level.name}`;
    bgX = 0;

    // âœ… Level deÄŸiÅŸince kapanÄ±ÅŸ kilidini sÄ±fÄ±rla (ama kapanÄ±ÅŸ aÃ§Ä±ldÄ±ysa zaten oyun bitecek)
    endLocked = false;
    endOverlay.style.display = "none";
  }

  // ---------- Utils ----------
  function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
  function rand(a,b){ return a + Math.random()*(b-a); }
  function rectHit(a,b){ return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y; }

  function showToast(msg){
    toast.textContent = msg;
    toast.style.display = 'block';
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toast.style.display='none', 900);
  }

  // ---------- Controls ----------
  function onTap(){
    // âœ… KapanÄ±ÅŸ aÃ§Ä±ldÄ±ysa hiÃ§bir ÅŸey yapma (asla kapanmasÄ±n)
    if(endLocked) return;

    if(state === "final"){
      // âœ… 3. bÃ¶lÃ¼m finalinde dokununca kapanÄ±ÅŸ notu aÃ§ ve oyun burada bitsin
      if(currentLevel === 3){
        endLocked = true;
        endTitle.textContent = END_NOTE_TITLE;
        endText.textContent  = END_NOTE_TEXT;
        endOverlay.style.display = "flex";
        return;
      }

      // level 1-2: normal devam
      finalVid.pause();
      finalVid.currentTime = 0;

      if(currentLevel < MAX_LEVEL){
        loadLevel(currentLevel + 1);
        state = "start";
        showToast(`â¡ï¸ ${level.name}`);
      } else {
        loadLevel(1);
        state = "start";
        showToast("ğŸ BaÅŸtan!");
      }
      return;
    }

    if(state === "start"){ startGame(); return; }
    if(state === "gameover"){ startGame(); return; }
    if(state !== "run") return;

    if(player.onGround){
      player.vy = JUMP_V;
      player.onGround = false;
    }
  }

  canvas.addEventListener('pointerdown', (e)=>{ e.preventDefault(); onTap(); });
  document.addEventListener('touchmove', e => { if(state==="run") e.preventDefault(); }, {passive:false});

  // ---------- Background: FULL HEIGHT + LOOP ----------
  function drawLoopBackgroundCover(img, parallaxSpeed){
    if(!ready(img)) {
      ctx.fillStyle = "#000";
      ctx.fillRect(0,0,W,H);
      return;
    }
    const scale = H / img.height;
    const drawW = img.width * scale;
    const drawH = H;

    bgX -= parallaxSpeed;
    bgX = bgX % drawW;
    if(bgX > 0) bgX -= drawW;

    for(let x = bgX; x < W + drawW; x += drawW){
      ctx.drawImage(img, x, 0, drawW, drawH);
    }
  }

  // âœ… Final cover helper
  function drawCoverMedia(media, mw, mh){
    const scale = Math.max(W / mw, H / mh);
    const dw = mw * scale;
    const dh = mh * scale;
    const dx = (W - dw) / 2;
    const dy = (H - dh) / 2;
    ctx.drawImage(media, dx, dy, dw, dh);
  }

  // ---------- Drawing ----------
  function drawHUD(){
    ctx.fillStyle = "rgba(234,241,255,.92)";
    ctx.font = "10px system-ui";
    ctx.fillText("Dokun = ZÄ±pla", 10, 16);

    ctx.fillStyle = "rgba(234,241,255,.85)";
    ctx.fillText(level.name, 10, 34);

    if(state === "run"){
      ctx.fillStyle = "rgba(234,241,255,.80)";
      ctx.fillText("SÃ¼re: " + Math.max(0, Math.ceil(LEVEL_SECONDS - elapsed)) + "sn", 10, 50);
      ctx.fillText("Kalkan: " + (player.shield ? "VAR" : "YOK"), 10, 64);
    }
  }

  function drawGroundLine(){
    ctx.fillStyle = "rgba(0,0,0,.22)";
    ctx.fillRect(0, GROUND_Y, W, 2);
  }

  function drawPlayer(){
    if(player.invul > 0 && Math.floor(performance.now()/90)%2===0) return;

    if(runLoaded > 0 && runFrames[0] && ready(runFrames[0])){
      const img = runFrames[runFrame] || runFrames[0];
      if(ready(img)){
        const scale = SPRITE_TARGET_H / img.height;
        const dw = (img.width * scale) | 0;
        const dh = (img.height * scale) | 0;

        const dx = (player.x + SPRITE_OX) | 0;
        const dy = (player.y + player.h - dh + SPRITE_OY) | 0;

        if(player.shield){
          ctx.save();
          ctx.globalAlpha = 0.35;
          ctx.fillStyle = "rgba(120,255,210,1)";
          ctx.beginPath();
          ctx.ellipse(dx + dw/2, dy + dh/2, dw*0.62, dh*0.62, 0, 0, Math.PI*2);
          ctx.fill();

          ctx.globalAlpha = 0.65;
          ctx.strokeStyle = "rgba(120,255,210,1)";
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.ellipse(dx + dw/2, dy + dh/2, dw*0.72, dh*0.72, 0, 0, Math.PI*2);
          ctx.stroke();
          ctx.restore();
        }

        ctx.drawImage(img, dx, dy, dw, dh);

        if(DEBUG_HITBOX){
          const pRect = { x: player.x + HB_OX, y: player.y + HB_OY, w: HB_W, h: HB_H };
          ctx.strokeStyle = "rgba(120,255,210,.9)";
          ctx.lineWidth = 1;
          ctx.strokeRect(pRect.x, pRect.y, pRect.w, pRect.h);
        }
      }
    } else {
      ctx.fillStyle = "#eaf1ff";
      ctx.fillRect(player.x, player.y, player.w, player.h);
    }
  }

  function drawObstacle(o){
    if(o.img && ready(o.img)){
      ctx.drawImage(o.img, o.x, o.y, o.w, o.h);
    } else {
      ctx.fillStyle = "#ff5b7a";
      ctx.fillRect(o.x, o.y, o.w, o.h);
    }

    if(DEBUG_HITBOX){
      const r = {
        x: o.x + (o.colOX || 0),
        y: o.y + (o.colOY || 0),
        w: o.colW || o.w,
        h: o.colH || o.h
      };
      ctx.strokeStyle = "rgba(255,80,80,.9)";
      ctx.lineWidth = 1;
      ctx.strokeRect(r.x, r.y, r.w, r.h);
    }
  }

  function drawShieldDrop(s){
    if(ready(shieldImg)){
      ctx.drawImage(shieldImg, s.x, s.y, s.w, s.h);
    } else {
      ctx.fillStyle="#5bd6ff";
      ctx.fillRect(s.x, s.y, s.w, s.h);
    }
  }

  function drawFinal(){
    if(finalVid.readyState >= 2){
      drawCoverMedia(finalVid, finalVid.videoWidth, finalVid.videoHeight);
    } else {
      ctx.fillStyle="#000";
      ctx.fillRect(0,0,W,H);
      ctx.fillStyle="#fff";
      ctx.font="16px system-ui";
      ctx.fillText("FINAL YÃœKLENÄ°YOR...", 40, 210);
    }

    ctx.fillStyle = "rgba(0,0,0,.35)";
    ctx.fillRect(0, 0, W, 42);
    ctx.fillStyle="#eaf1ff";
    ctx.font="12px system-ui";
    ctx.fillText(`${level.name} TamamlandÄ±!`, 10, 18);
    ctx.font="10px system-ui";
    ctx.fillText("Dokun â†’ Devam", 10, 34);
  }

  function drawStart(){
    drawLoopBackgroundCover(level.bg, 0);
    drawGroundLine();

    runFrame = 0;

    ctx.fillStyle="rgba(0,0,0,.35)";
    ctx.fillRect(0, 0, W, H);

    ctx.fillStyle="#eaf1ff";
    ctx.font="16px system-ui";
    ctx.fillText("Dokun ve BaÅŸla", 55, 200);
    ctx.font="11px system-ui";
    ctx.fillStyle="rgba(234,241,255,.8)";
    ctx.fillText(level.hint, 56, 224);
    ctx.fillText("Kalkan: 1 Ã§arpma affeder", 44, 242);

    drawPlayer();
  }

  function drawGameOver(){
    ctx.fillStyle="rgba(0,0,0,.55)";
    ctx.fillRect(0,0,W,H);
    ctx.fillStyle="#eaf1ff";
    ctx.font="16px system-ui";
    ctx.fillText("Ã‡ARPTIN!", 86, 190);
    ctx.font="11px system-ui";
    ctx.fillText("Dokun â†’ Tekrar", 72, 214);
  }

  // ---------- Spawning ----------
  function spawnObstacle(){ level.spawnObstacle(); }

  function spawnShield(){
    const size = 22;
    shieldDrops.push({
      x: W + 20,
      y: (GROUND_Y - 78 - rand(0,22)) | 0,
      w: size,
      h: size
    });
  }

  // ---------- Quiz ----------
  function openQuiz(){
    state = "quiz";
    overlay.style.display = "flex";

    const q = quizzes[quizIndex];
    qtext.textContent = q.q;
    optBtns.forEach((btn,i)=>{
      btn.disabled = false;
      btn.textContent = (["A) ","B) ","C) ","D) "][i]) + q.options[i];
    });
  }

  function closeQuiz(){ overlay.style.display = "none"; }

  optBtns.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const picked = Number(btn.dataset.i);
      const q = quizzes[quizIndex];

      optBtns.forEach(b=> b.disabled = true);

      showToast(picked === q.correct ? "âœ… DoÄŸru" : "âŒ YanlÄ±ÅŸ");
      quizIndex++;

      setTimeout(()=>{
        if(quizIndex >= quizzes.length){
          closeQuiz();
          state = "final";
          finalVid.currentTime = 0;
          finalVid.play().catch(()=>{});
        } else {
          const nq = quizzes[quizIndex];
          qtext.textContent = nq.q;
          optBtns.forEach((b,i)=>{
            b.disabled = false;
            b.textContent = (["A) ","B) ","C) ","D) "][i]) + nq.options[i];
          });
        }
      }, 450);
    });
  });

  // ---------- Game flow ----------
  function startGame(){
    // âœ… kapanÄ±ÅŸ kilidini kÄ±rma: kapanÄ±ÅŸ aÃ§Ä±ldÄ±ysa oyun bitmiÅŸ demek
    if(endLocked) return;

    state = "run";
    elapsed = 0;
    speed = 2.8;
    bgX = 0;

    obstacles = [];
    shieldDrops = [];

    player.y = GROUND_Y - player.h;
    player.vy = 0;
    player.onGround = true;
    player.shield = false;
    player.invul = 0;

    nextSpawn = 40;
    nextShield = 520 + (Math.random()*360);

    quizIndex = 0;
    closeQuiz();

    resetRunAnim();

    finalVid.pause();
    finalVid.currentTime = 0;

    showToast("ğŸ BaÅŸla!");
  }

  // ---------- Main loop ----------
  let lastTs = 0;
  function step(ts){
    requestAnimationFrame(step);
    if(!lastTs) lastTs = ts;
    const dt = Math.min(0.05, (ts - lastTs) / 1000);
    lastTs = ts;

    if(state === "start"){
      drawStart();
      return;
    }

    if(state === "final"){
      drawFinal();
      return;
    }

    drawLoopBackgroundCover(level.bg, (state==="run" ? speed*0.35 : 0));
    drawGroundLine();
    drawHUD();

    if(state === "quiz"){
      drawPlayer();
      obstacles.forEach(drawObstacle);
      shieldDrops.forEach(drawShieldDrop);
      return;
    }

    if(state === "gameover"){
      drawPlayer();
      obstacles.forEach(drawObstacle);
      shieldDrops.forEach(drawShieldDrop);
      drawGameOver();
      return;
    }

    // ---------- RUN ----------
    elapsed += dt;
    updateRunAnim(dt);

    if(elapsed >= LEVEL_SECONDS){
      openQuiz();
      return;
    }

    // fizik
    player.vy += GRAV * (dt * 60);
    player.y += player.vy;

    if(player.y >= GROUND_Y - player.h){
      player.y = GROUND_Y - player.h;
      player.vy = 0;
      player.onGround = true;
    }

    // spawn
    nextSpawn -= dt * 60;
    if(nextSpawn <= 0){
      spawnObstacle();
      const base = Math.random() * (85-45) + 45;
      nextSpawn = clamp((base / (1 + (speed-2.8)*0.25)), 28, 95);
    }

    nextShield -= dt * 60;
    if(nextShield <= 0){
      if(!player.shield) spawnShield();
      nextShield = 520 + (Math.random()*360);
    }

    speed += 0.0009 * (dt * 60);

    const pRect = {
      x: player.x + HB_OX,
      y: player.y + HB_OY,
      w: HB_W,
      h: HB_H
    };

    // engeller
    for(let i=obstacles.length-1; i>=0; i--){
      const o = obstacles[i];
      o.x -= speed * (dt * 60);
      drawObstacle(o);

      if(o.x + o.w < -30) { obstacles.splice(i,1); continue; }

      const oRect = {
        x: o.x + (o.colOX || 0),
        y: o.y + (o.colOY || 0),
        w: o.colW || o.w,
        h: o.colH || o.h
      };

      if(rectHit(pRect, oRect)){
        if(player.shield){
          player.shield = false;
          obstacles.splice(i,1);
          showToast("ğŸ›¡ Kalkan kÄ±rÄ±ldÄ±!");
        } else {
          state = "gameover";
          showToast("ğŸ’¥ Ã‡arptÄ±n");
        }
      }
    }

    // kalkanlar
    for(let i=shieldDrops.length-1; i>=0; i--){
      const s = shieldDrops[i];
      s.x -= (speed * 0.75) * (dt * 60);
      drawShieldDrop(s);

      if(s.x + s.w < -30) { shieldDrops.splice(i,1); continue; }

      if(rectHit(pRect, s)){
        player.shield = true;
        shieldDrops.splice(i,1);
        showToast("ğŸ›¡ Kalkan aldÄ±n!");
      }
    }

    if(DEBUG_HITBOX){
      ctx.strokeStyle = "rgba(120,255,210,.9)";
      ctx.lineWidth = 1;
      ctx.strokeRect(pRect.x, pRect.y, pRect.w, pRect.h);
    }

    drawPlayer();
  }

  // init
  loadLevel(1);
  requestAnimationFrame(step);
  state = "start";
})();
</script>
</body>
</html>
