<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Yusuf Runner - B√∂l√ºm 1</title>
  <style>
    :root { color-scheme: dark; }
    html, body { margin:0; height:100%; background:#0b0f14; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #wrap { height:100%; display:flex; align-items:center; justify-content:center; padding:12px; }
    canvas{
      width:min(92vw, 420px);
      height:calc(min(92vw, 420px) * 1.78);
      background:#000;
      border:2px solid rgba(255,255,255,.12);
      border-radius:14px;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      touch-action: manipulation;
    }

    #overlay{
      position:fixed; inset:0; display:none;
      background:rgba(0,0,0,.60);
      align-items:center; justify-content:center;
      padding:18px;
    }
    #card{
      width:min(520px, 92vw);
      background:#111826;
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:16px;
      box-shadow:0 16px 50px rgba(0,0,0,.5);
    }
    #qtitle{ margin:0 0 8px; font-size:16px; opacity:.9; }
    #qtext{ margin:0 0 12px; font-size:18px; line-height:1.25; }
    .opt{
      width:100%;
      text-align:left;
      padding:12px;
      margin:8px 0;
      background:#0e1522;
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      color:#eaf1ff;
      font-size:16px;
    }
    #hint{ margin:10px 2px 0; font-size:13px; opacity:.75; }

    #toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px; padding:10px 14px;
      background:rgba(17,24,38,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px; display:none;
      font-size:14px;
      max-width:92vw;
      text-align:center;
    }
  </style>
</head>
<body>
<div id="wrap">
  <canvas id="c" width="240" height="426"></canvas>
</div>

<div id="overlay">
  <div id="card">
    <p id="qtitle">Quiz</p>
    <p id="qtext">Soru</p>
    <button class="opt" data-i="0"></button>
    <button class="opt" data-i="1"></button>
    <button class="opt" data-i="2"></button>
    <button class="opt" data-i="3"></button>
    <p id="hint">3 soru var. Bitince final ekranƒ±na ge√ßeceksin.</p>
  </div>
</div>

<div id="toast"></div>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  ctx.imageSmoothingEnabled = false;

  const overlay = document.getElementById('overlay');
  const qtext = document.getElementById('qtext');
  const optBtns = Array.from(document.querySelectorAll('.opt'));
  const toast = document.getElementById('toast');

  const W = canvas.width, H = canvas.height;

  // ---------- Assets ----------
  const bgImg = new Image();     bgImg.src = "assets/bg_loop.png";
  const paperImg = new Image();  paperImg.src = "assets/paper.png";
  const booksImg1 = new Image(); booksImg1.src = "assets/books2.png";
  const booksImg2 = new Image(); booksImg2.src = "assets/books3.png";
  const shieldImg = new Image(); shieldImg.src = "assets/shield.png";

  // ‚úÖ FINAL MP4
  const finalVid = document.createElement("video");
  finalVid.src = "assets/final.mp4";
  finalVid.loop = true;
  finalVid.muted = true;       // autoplay policy
  finalVid.playsInline = true; // iOS
  finalVid.preload = "auto";

  function ready(img){ return img && img.complete && img.naturalWidth > 0; }

  // ---------- RUN SPRITE (193 frame) ----------
  // assets/run_frames/frame_000.png ... frame_192.png
  const RUN_DIR = "assets/run_frames";
  const RUN_TOTAL = 193;
  const RUN_INTRO_END = 5;   // 0..5 1 kere
  const RUN_LOOP_START = 6;  // 6..192 loop
  const RUN_FPS = 24;

  const runFrames = new Array(RUN_TOTAL);
  let runLoaded = 0;

  for(let i=0;i<RUN_TOTAL;i++){
    const im = new Image();
    im.src = `${RUN_DIR}/frame_${String(i).padStart(3,'0')}.png`;
    im.onload = ()=> runLoaded++;
    runFrames[i] = im;
  }

  let runFrame = 0;
  let runPhase = "intro";
  let runAcc = 0;

  function resetRunAnim(){
    runFrame = 0;
    runPhase = "intro";
    runAcc = 0;
  }

  function updateRunAnim(dt){
    runAcc += dt;
    const step = 1 / RUN_FPS;
    while(runAcc >= step){
      runAcc -= step;
      runFrame++;

      if(runPhase === "intro"){
        if(runFrame > RUN_INTRO_END){
          runPhase = "run";
          runFrame = RUN_LOOP_START; // 6
        }
      } else {
        if(runFrame >= RUN_TOTAL){
          runFrame = RUN_LOOP_START; // 6'dan d√∂n
        }
      }
    }
  }

  // ‚úÖ Karakter boyutu: hedef y√ºkseklik (px)
  // B√ºy√ºk gelirse 80'e indir, k√º√ß√ºk gelirse 95-110
  const SPRITE_TARGET_H = 85;
  const SPRITE_OX = -6;
  const SPRITE_OY = -2;

  // ---------- Game constants ----------
  const GROUND_Y = 382;
  const GRAV = 0.55;
  const JUMP_V = -10.2;

  // ---------- State ----------
  let state = "start"; // start | run | quiz | final | gameover
  let speed = 2.8;

  // background loop offset
  let bgX = 0;

  const player = {
    x: 44, y: GROUND_Y - 18,
    w: 14, h: 18,
    vy: 0, onGround: true,
    shield: false,
    invul: 0
  };

  let obstacles = [];
  let nextSpawn = 40;

  let shieldDrops = [];
  let nextShield = 200;

  let elapsed = 0;

  const LEVEL_SECONDS = 45;

  // Quiz
  const quizzes = [
    { q:"Yusuf‚Äôun bu b√∂l√ºmde hedefi ne?", options:["Ko≈ümak","√úniversiteye ula≈ümak","Balƒ±k tutmak","Uyumak"], correct:1 },
    { q:"B√∂l√ºm 1 nerede ge√ßiyor?", options:["Kadƒ±k√∂y","Be≈üikta≈ü","Ankara","ƒ∞zmir"], correct:1 },
    { q:"Finalde ne oluyor?", options:["Kaybediyor","Mezun oluyor","U√ßuyor","Kayboluyor"], correct:1 },
  ];
  let quizIndex = 0;

  // ---------- Utils ----------
  function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
  function rand(a,b){ return a + Math.random()*(b-a); }
  function rectHit(a,b){ return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y; }

  function showToast(msg){
    toast.textContent = msg;
    toast.style.display = 'block';
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toast.style.display='none', 900);
  }

  // ---------- Controls (tek handler) ----------
  function onTap(){
    if(state === "final"){
      finalVid.pause();
      finalVid.currentTime = 0;
      state = "start";
      return;
    }

    if(state === "start"){ startGame(); return; }
    if(state === "gameover"){ startGame(); return; }
    if(state !== "run") return;

    if(player.onGround){
      player.vy = JUMP_V;
      player.onGround = false;
    }
  }

  canvas.addEventListener('pointerdown', (e)=>{ e.preventDefault(); onTap(); });
  document.addEventListener('touchmove', e => { if(state==="run") e.preventDefault(); }, {passive:false});

  // ---------- Background: FULL HEIGHT + LOOP ----------
  function drawLoopBackgroundCover(img, parallaxSpeed){
    if(!ready(img)) {
      ctx.fillStyle = "#000";
      ctx.fillRect(0,0,W,H);
      return;
    }

    const scale = H / img.height;
    const drawW = img.width * scale;
    const drawH = H;

    bgX -= parallaxSpeed;
    bgX = bgX % drawW;
    if(bgX > 0) bgX -= drawW;

    for(let x = bgX; x < W + drawW; x += drawW){
      ctx.drawImage(img, x, 0, drawW, drawH);
    }
  }

  // ---------- Drawing ----------
  function drawHUD(){
    ctx.fillStyle = "rgba(234,241,255,.92)";
    ctx.font = "10px system-ui";
    ctx.fillText("Dokun = Zƒ±pla", 10, 16);

    ctx.fillStyle = "rgba(234,241,255,.85)";
    ctx.fillText("B√∂l√ºm 1 ‚Äî Be≈üikta≈ü", 10, 34);

    if(state === "run"){
      ctx.fillStyle = "rgba(234,241,255,.80)";
      ctx.fillText("S√ºre: " + Math.max(0, Math.ceil(LEVEL_SECONDS - elapsed)) + "sn", 10, 50);
      ctx.fillText("Kalkan: " + (player.shield ? "VAR" : "YOK"), 10, 64);
    }
  }

  function drawGroundLine(){
    ctx.fillStyle = "rgba(0,0,0,.22)";
    ctx.fillRect(0, GROUND_Y, W, 2);
  }

  function drawPlayer(){
    if(player.invul > 0 && Math.floor(performance.now()/90)%2===0) return;

    if(runLoaded > 0 && runFrames[0] && ready(runFrames[0])){
      const img = runFrames[runFrame] || runFrames[0];
      if(ready(img)){
        // ‚úÖ otomatik scale: hedef y√ºksekliƒüe g√∂re
        const scale = SPRITE_TARGET_H / img.height;
        const dw = (img.width * scale) | 0;
        const dh = (img.height * scale) | 0;

        const dx = (player.x + SPRITE_OX) | 0;
        // ‚úÖ ayaklarƒ± zemine kilitle
        const dy = (GROUND_Y - dh + SPRITE_OY) | 0;

        ctx.drawImage(img, dx, dy, dw, dh);
      }
    } else {
      ctx.fillStyle = "#eaf1ff";
      ctx.fillRect(player.x, player.y, player.w, player.h);
    }

    if(player.shield){
      ctx.strokeStyle = "rgba(120,255,210,.9)";
      ctx.lineWidth = 2;
      ctx.strokeRect(player.x-2, player.y-2, player.w+4, player.h+4);
      ctx.lineWidth = 1;
    }
  }

  function drawObstacle(o){
    if(o.img && ready(o.img)){
      ctx.drawImage(o.img, o.x, o.y, o.w, o.h);
    } else {
      ctx.fillStyle = "#ff5b7a";
      ctx.fillRect(o.x, o.y, o.w, o.h);
    }
  }

  function drawShieldDrop(s){
    if(ready(shieldImg)){
      ctx.drawImage(shieldImg, s.x, s.y, s.w, s.h);
    } else {
      ctx.fillStyle="#5bd6ff";
      ctx.fillRect(s.x, s.y, s.w, s.h);
    }
  }

  function drawFinal(){
    if(finalVid.readyState >= 2){
      const scale = H / finalVid.videoHeight;
      const drawW = finalVid.videoWidth * scale;
      const drawH = H;
      const x = (W - drawW) / 2;
      ctx.drawImage(finalVid, x, 0, drawW, drawH);
    } else {
      ctx.fillStyle="#000";
      ctx.fillRect(0,0,W,H);
      ctx.fillStyle="#fff";
      ctx.font="16px system-ui";
      ctx.fillText("FINAL Y√úKLENƒ∞YOR...", 40, 210);
    }

    ctx.fillStyle = "rgba(0,0,0,.35)";
    ctx.fillRect(0, 0, W, 42);
    ctx.fillStyle="#eaf1ff";
    ctx.font="12px system-ui";
    ctx.fillText("B√∂l√ºm 1 Tamamlandƒ±!", 10, 18);
    ctx.font="10px system-ui";
    ctx.fillText("Dokun ‚Üí Devam", 10, 34);
  }

  function drawStart(){
    drawLoopBackgroundCover(bgImg, 0);
    drawGroundLine();

    runFrame = 0;

    ctx.fillStyle="rgba(0,0,0,.35)";
    ctx.fillRect(0, 0, W, H);

    ctx.fillStyle="#eaf1ff";
    ctx.font="16px system-ui";
    ctx.fillText("Dokun ve Ba≈üla", 55, 200);
    ctx.font="11px system-ui";
    ctx.fillStyle="rgba(234,241,255,.8)";
    ctx.fillText("Engeller: Kaƒüƒ±t + Kitap", 56, 224);
    ctx.fillText("Kalkan: 1 √ßarpma affeder", 44, 242);

    drawPlayer();
  }

  function drawGameOver(){
    ctx.fillStyle="rgba(0,0,0,.55)";
    ctx.fillRect(0,0,W,H);
    ctx.fillStyle="#eaf1ff";
    ctx.font="16px system-ui";
    ctx.fillText("√áARPTIN!", 86, 190);
    ctx.font="11px system-ui";
    ctx.fillText("Dokun ‚Üí Tekrar", 72, 214);
  }

  // ---------- Spawning ----------
  function spawnObstacle(){
    const r = Math.random();

    if(r < 0.45){
      const w = 40, h = 32;
      obstacles.push({
        img: paperImg,
        x: W + 20,
        y: (GROUND_Y - 110 - Math.random()*45) | 0,
        w, h
      });
    } else {
      const img = Math.random() < 0.5 ? booksImg1 : booksImg2;
      const w = 44;
      const h = (img === booksImg1) ? 28 : 40;

      obstacles.push({
        img,
        x: W + 20,
        y: GROUND_Y - h,
        w, h
      });
    }
  }

  function spawnShield(){
    const size = 22;
    shieldDrops.push({
      x: W + 20,
      y: (GROUND_Y - 78 - rand(0,22)) | 0,
      w: size,
      h: size
    });
  }

  // ---------- Quiz ----------
  function openQuiz(){
    state = "quiz";
    overlay.style.display = "flex";

    const q = quizzes[quizIndex];
    qtext.textContent = q.q;
    optBtns.forEach((btn,i)=>{
      btn.disabled = false;
      btn.textContent = (["A) ","B) ","C) ","D) "][i]) + q.options[i];
    });
  }

  function closeQuiz(){
    overlay.style.display = "none";
  }

  optBtns.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const picked = Number(btn.dataset.i);
      const q = quizzes[quizIndex];

      optBtns.forEach(b=> b.disabled = true);

      showToast(picked === q.correct ? "‚úÖ Doƒüru" : "‚ùå Yanlƒ±≈ü");
      quizIndex++;

      setTimeout(()=>{
        if(quizIndex >= quizzes.length){
          closeQuiz();
          state = "final";
          finalVid.currentTime = 0;
          finalVid.play().catch(()=>{});
        } else {
          const nq = quizzes[quizIndex];
          qtext.textContent = nq.q;
          optBtns.forEach((b,i)=>{
            b.disabled = false;
            b.textContent = (["A) ","B) ","C) ","D) "][i]) + nq.options[i];
          });
        }
      }, 450);
    });
  });

  // ---------- Game flow ----------
  function startGame(){
    state = "run";
    elapsed = 0;
    speed = 2.8;
    bgX = 0;

    obstacles = [];
    shieldDrops = [];

    player.y = GROUND_Y - player.h;
    player.vy = 0;
    player.onGround = true;
    player.shield = false;
    player.invul = 0;

    nextSpawn = 40;

    nextShield = 520 + (Math.random()*360);

    quizIndex = 0;
    closeQuiz();

    resetRunAnim();

    finalVid.pause();
    finalVid.currentTime = 0;

    showToast("üèÅ Ba≈üla!");
  }

  // ---------- Main loop (dt ile) ----------
  let lastTs = 0;
  function step(ts){
    requestAnimationFrame(step);
    if(!lastTs) lastTs = ts;
    const dt = Math.min(0.05, (ts - lastTs) / 1000);
    lastTs = ts;

    if(state === "start"){
      drawStart();
      return;
    }

    if(state === "final"){
      drawFinal();
      return;
    }

    drawLoopBackgroundCover(bgImg, (state==="run" ? speed*0.35 : 0));
    drawGroundLine();
    drawHUD();

    if(state === "quiz"){
      drawPlayer();
      obstacles.forEach(drawObstacle);
      shieldDrops.forEach(drawShieldDrop);
      return;
    }

    if(state === "gameover"){
      drawPlayer();
      obstacles.forEach(drawObstacle);
      shieldDrops.forEach(drawShieldDrop);
      drawGameOver();
      return;
    }

    // ---------- RUN ----------
    elapsed += dt;

    updateRunAnim(dt);

    if(elapsed >= LEVEL_SECONDS){
      openQuiz();
      return;
    }

    // fizik
    player.vy += GRAV * (dt * 60);
    player.y += player.vy;

    if(player.y >= GROUND_Y - player.h){
      player.y = GROUND_Y - player.h;
      player.vy = 0;
      player.onGround = true;
    }

    // engel spawn
    nextSpawn -= dt * 60;
    if(nextSpawn <= 0){
      spawnObstacle();
      const base = rand(45, 85);
      nextSpawn = clamp((base / (1 + (speed-2.8)*0.25)), 28, 95);
    }

    // kalkan spawn
    nextShield -= dt * 60;
    if(nextShield <= 0){
      if(!player.shield){
        spawnShield();
      }
      nextShield = 520 + (Math.random()*360);
    }

    // hƒ±z artƒ±≈üƒ±
    speed += 0.0009 * (dt * 60);

    const pRect = { x: player.x, y: player.y, w: player.w, h: player.h };

    // engeller
    for(let i=obstacles.length-1; i>=0; i--){
      const o = obstacles[i];
      o.x -= speed * (dt * 60);
      drawObstacle(o);

      if(o.x + o.w < -30) { obstacles.splice(i,1); continue; }

      if(rectHit(pRect, o)){
        if(player.shield){
          player.shield = false;
          obstacles.splice(i,1);
          showToast("üõ° Kalkan kƒ±rƒ±ldƒ±!");
        } else {
          state = "gameover";
          showToast("üí• √áarptƒ±n");
        }
      }
    }

    // kalkanlar
    for(let i=shieldDrops.length-1; i>=0; i--){
      const s = shieldDrops[i];
      s.x -= (speed * 0.75) * (dt * 60);
      drawShieldDrop(s);

      if(s.x + s.w < -30) { shieldDrops.splice(i,1); continue; }

      if(rectHit(pRect, s)){
        player.shield = true;
        shieldDrops.splice(i,1);
        showToast("üõ° Kalkan aldƒ±n!");
      }
    }

    drawPlayer();
  }

  requestAnimationFrame(step);

  // start ekranƒ± i√ßin
  state = "start";
})();
</script>
</body>
</html>
